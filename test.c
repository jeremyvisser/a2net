#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>

#define _TEST_C

#include "log.h"
#include "ip.h"
#include "packet.h"

in6_addr myip = {
  {
    {
      // 2403:5800:7100:1300::a2e
      0x24, 0x03, 0x58, 0x00, 0x71, 0x00, 0x13, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x2e
    }
  }
};

// 2403:5800:7100:1300:e9e5:5240:22f2:134b	2403:5800:7100:1300::2	ICMPv6	118	Echo (ping) request id=0x0001, seq=1
static const unsigned char req1[] = {
0x60, 0x0b, /* `. */
0xfa, 0xa9, 0x00, 0x40, 0x3a, 0x40, 0x24, 0x03, /* ...@:@$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0xe9, 0xe5, /* X.q..... */
0x52, 0x40, 0x22, 0xf2, 0x13, 0x4b, 0x24, 0x03, /* R@"..K$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0x00, 0x00, /* X.q..... */
0x00, 0x00, 0x00, 0x00, 0x0a, 0x2e, 0x80, 0x00, /* ........ */
0xe5, 0x8d, 0x00, 0x01, 0x00, 0x01, 0xa4, 0x8e, /* ........ */
0x44, 0x61, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x99, /* Da....j. */
0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, /* ........ */
0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, /* ........ */
0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, /* ...... ! */
0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, /* "#$%&'() */
0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, /* *+,-./01 */
0x32, 0x33, 0x34, 0x35, 0x36, 0x37              /* 234567 */
};

// 2403:5800:7100:1300:e9e5:5240:22f2:134b 2403:5800:7100:1300::2 ICMPv6   118    Echo (ping) request id=0x0001, seq=2
static const unsigned char req2[] = {
0x60, 0x0b, /* `. */
0xfa, 0xa9, 0x00, 0x40, 0x3a, 0x40, 0x24, 0x03, /* ...@:@$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0xe9, 0xe5, /* X.q..... */
0x52, 0x40, 0x22, 0xf2, 0x13, 0x4b, 0x24, 0x03, /* R@"..K$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0x00, 0x00, /* X.q..... */
0x00, 0x00, 0x00, 0x00, 0x0a, 0x2e, 0x80, 0x00, /* ........ */
0xac, 0x87, 0x00, 0x01, 0x00, 0x02, 0xa5, 0x8e, /* ........ */
0x44, 0x61, 0x00, 0x00, 0x00, 0x00, 0xa2, 0x9e, /* Da...... */
0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, /* ........ */
0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, /* ........ */
0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, /* ...... ! */
0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, /* "#$%&'() */
0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, /* *+,-./01 */
0x32, 0x33, 0x34, 0x35, 0x36, 0x37              /* 234567 */
};

#if 0
// 2403:5800:7100:1300::2 2403:5800:7100:1300:e9e5:5240:22f2:134b ICMPv6   118    Echo (ping) reply id=0x0001, seq=1
static const unsigned char reply1[] = {
0x60, 0x01, /* `. */
0x76, 0xd6, 0x00, 0x40, 0x3a, 0x40, 0x24, 0x03, /* v..@:@$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0x00, 0x00, /* X.q..... */
0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x24, 0x03, /* ......$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0xe9, 0xe5, /* X.q..... */
0x52, 0x40, 0x22, 0xf2, 0x13, 0x4b, 0x81, 0x00, /* R@"..K.. */
0xee, 0xb9, 0x00, 0x01, 0x00, 0x01, 0xa4, 0x8e, /* ........ */
0x44, 0x61, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x99, /* Da....j. */
0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, /* ........ */
0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, /* ........ */
0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, /* ...... ! */
0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, /* "#$%&'() */
0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, /* *+,-./01 */
0x32, 0x33, 0x34, 0x35, 0x36, 0x37              /* 234567 */
};

// 2403:5800:7100:1300::2 2403:5800:7100:1300:e9e5:5240:22f2:134b ICMPv6   118    Echo (ping) reply id=0x0001, seq=2
static const unsigned char reply2[] = {
0x60, 0x01, /* `. */
0x76, 0xd6, 0x00, 0x40, 0x3a, 0x40, 0x24, 0x03, /* v..@:@$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0x00, 0x00, /* X.q..... */
0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x24, 0x03, /* ......$. */
0x58, 0x00, 0x71, 0x00, 0x13, 0x00, 0xe9, 0xe5, /* X.q..... */
0x52, 0x40, 0x22, 0xf2, 0x13, 0x4b, 0x81, 0x00, /* R@"..K.. */
0xb5, 0xb3, 0x00, 0x01, 0x00, 0x02, 0xa5, 0x8e, /* ........ */
0x44, 0x61, 0x00, 0x00, 0x00, 0x00, 0xa2, 0x9e, /* Da...... */
0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x11, /* ........ */
0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, /* ........ */
0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, /* ...... ! */
0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, /* "#$%&'() */
0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, /* *+,-./01 */
0x32, 0x33, 0x34, 0x35, 0x36, 0x37              /* 234567 */
};
#endif

typedef struct pcap_hdr_s {
  uint32_t magic_number;   /* magic number */
  uint16_t version_major;  /* major version number */
  uint16_t version_minor;  /* minor version number */
  int32_t  thiszone;       /* GMT to local correction */
  uint32_t sigfigs;        /* accuracy of timestamps */
  uint32_t snaplen;        /* max length of captured packets, in octets */
  uint32_t network;        /* data link type */
} pcap_hdr_t;

typedef struct pcaprec_hdr_s {
  uint32_t ts_sec;         /* timestamp seconds */
  uint32_t ts_usec;        /* timestamp microseconds */
  uint32_t incl_len;       /* number of octets of packet saved in file */
  uint32_t orig_len;       /* actual length of packet */
} pcaprec_hdr_t;


// https://stackoverflow.com/a/29865/10839
void fhexdump(FILE *f, const void *ptr, int buflen) {
  unsigned char *buf = (unsigned char*)ptr;
  int i, j;
  for (i=0; i<buflen; i+=16) {
    fprintf(f, "%06x: ", i);
    for (j=0; j<16; j++) 
      if (i+j < buflen)
        fprintf(f, "%02x ", buf[i+j]);
      else
        fprintf(f, "   ");
    fprintf(f, " ");
    for (j=0; j<16; j++) 
      if (i+j < buflen)
        fprintf(f, "%c", isprint(buf[i+j]) ? buf[i+j] : '.');
    fprintf(f, "\n");
  }
}

int main(int argc, char *argv[]) {
  uint8_t i;
  uint8_t pcap = !isatty(fileno(stdout));

  if (pcap) {
    pcap_hdr_t h = {
      0xa1b2c3d4,
      2, 4,
      0, // UTC
      0,
      0xFFFF,
      101 // LINKTYPE_RAW: raw IP
    };
    fwrite(&h, 1, sizeof(h), stdout);
  }

  ipv6_set_addr(&myip);

  struct pktbuf *buf;

  buf = push_recv_q();
  buf->plen = sizeof(req1);
  memcpy(buf->data, req1, sizeof(buf->data));

  buf = push_recv_q();
  buf->plen = sizeof(req2);
  memcpy(buf->data, req2, sizeof(buf->data));

  logf(DEBUG, "recv_q.c = %u\n", recv_q.c);
  for (i = 0; i < recv_q.c; i++) {
    logf(DEBUG, "### recv_q.q[%d]:\n", i);
    fhexdump(stderr, recv_q.q[i].data, recv_q.q[i].plen);
    if (pcap) {
      pcaprec_hdr_t r = { 0, 0, recv_q.q[i].plen, recv_q.q[i].plen, };
      fwrite(&r, 1, sizeof(r), stdout);
      fwrite(recv_q.q[i].data, 1, recv_q.q[i].plen, stdout);
    }
  }

  handle_recv_queue();

  logf(DEBUG, "send_q.c = %u\n", send_q.c);
  for (i = 0; i < send_q.c; i++) {
    logf(DEBUG, "### send_q.q[%d]:\n", i);
    fhexdump(stderr, send_q.q[i].data, send_q.q[i].plen);
    if (pcap) {
      pcaprec_hdr_t r = { 0, 0, send_q.q[i].plen, send_q.q[i].plen, };
      fwrite(&r, 1, sizeof(r), stdout);
      fwrite(send_q.q[i].data, 1, send_q.q[i].plen, stdout);
    }
  }
}

